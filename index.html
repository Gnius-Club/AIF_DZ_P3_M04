<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>La Central de Correo: Inspector Anti-Phishing</title>
<style>
  /* ===================
     ESTILOS GENERALES
     =================== */
  :root{
    --bg:#0b132b;
    --panel:#1c2541;
    --panel-2:#3a506b;
    --ok:#31c48d;  /* verde */
    --bad:#ef4444; /* rojo */
    --accent:#e9c46a; /* dorado */
    --ink:#f1f5f9; /* texto claro */
    --muted:#cbd5e1;
    --focus:#f59e0b;
  }
  html,body{height:100%;}
  body{
    margin:0; background:linear-gradient(180deg,var(--bg),#0d1b2a);
    color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",sans-serif;
  }
  *{box-sizing:border-box}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  a{color:#93c5fd}
  button{font:inherit}
  button:focus,[tabindex]:focus{outline:3px solid var(--focus);outline-offset:2px}

  /* Layout */
  .topbar{display:flex;align-items:center;gap:16px;justify-content:space-between;padding:10px 14px;background:rgba(58,80,107,.8);backdrop-filter:blur(6px);position:sticky;top:0;z-index:5;border-bottom:1px solid #0006}
  .topbar .stats{display:flex;gap:16px;align-items:center}
  .pill{background:var(--panel);border:1px solid #0006;padding:6px 10px;border-radius:999px;font-weight:700}
  .hearts{letter-spacing:4px}
  .container{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;padding:14px;max-width:1200px;margin:0 auto}
  .panel{background:var(--panel);border:1px solid #0008;border-radius:16px;box-shadow:0 8px 24px #0006;overflow:hidden}
  .panel .head{padding:10px 14px;background:var(--panel-2);display:flex;align-items:center;gap:8px;border-bottom:1px solid #0006}
  .panel .body{padding:14px}

  /* Tarjeta del mensaje */
  .card{display:grid;gap:8px}
  .row{display:grid;grid-template-columns:120px 1fr;gap:8px}
  .label{color:var(--muted)}
  .message-body{background:#0f172a; padding:12px;border-radius:12px;min-height:140px;line-height:1.45}
  .links{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .tag{background:#0b2239;border:1px dashed #224;padding:4px 8px;border-radius:999px;font-size:14px}

  /* Herramientas */
  .tools{display:grid;gap:10px}
  .tool-btn{display:flex;align-items:center;gap:10px;width:100%;padding:12px 14px;border-radius:14px;border:2px solid #0006;background:#0b2239;cursor:pointer;transition:.15s transform,.15s background}
  .tool-btn:hover{transform:translateY(-1px);background:#0e2b47}
  .tool-legend{font-size:14px;color:var(--muted)}

  /* Botones de decisiÃ³n */
  .actions{display:flex;gap:12px;margin-top:12px}
  .btn{flex:1; padding:14px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:800;letter-spacing:.5px}
  .btn-yes{background:linear-gradient(#0e9f6e,#0ea868);border:2px solid #064e3b}
  .btn-no{background:linear-gradient(#ef4444,#dc2626);border:2px solid #7f1d1d}

  /* Barra inferior feedback */
  .bottombar{position:sticky;bottom:0;background:rgba(26,40,61,.9);border-top:1px solid #0008;backdrop-filter:blur(6px);}
  .bottombar .inner{max-width:1200px;margin:0 auto;padding:10px 14px;display:flex;align-items:center;gap:10px}
  .feedback{flex:1;min-height:24px}

  .highlight-red{background:rgba(239,68,68,.25);border-bottom:2px solid var(--bad);border-radius:4px;padding:0 2px}
  .highlight-yellow{background:rgba(250,204,21,.2);border-bottom:2px solid #f59e0b;border-radius:4px;padding:0 2px}

  .url-bubble{position:absolute;pointer-events:none;background:#0b2239;color:#e2e8f0;border:1px solid #11304e;padding:6px 8px;border-radius:8px;font-size:12px;z-index:50;white-space:nowrap;transform:translate(-50%,-130%)}

  /* Animaciones de aprobaciÃ³n/rechazo (mini â€œtuboâ€ y â€œincineradorâ€) */
  .canvas-wrap{position:relative;height:160px;margin-top:8px;border:1px dashed #274; border-radius:12px;background:repeating-linear-gradient(45deg, #0a1f2f, #0a1f2f 10px, #0b2239 10px, #0b2239 20px)}
  canvas{width:100%;height:100%}

  /* MenÃº superior derecho */
  .menu{display:flex;align-items:center;gap:10px}
  .toggle{display:inline-flex;gap:8px;align-items:center;background:#0b2239;border:1px solid #0006;padding:6px 10px;border-radius:999px;cursor:pointer}

  /* Modal de ayuda/tutorial */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:30}
  .modal.show{display:flex}
  .modal .box{width:min(720px,94vw);background:#0b2239;border:2px solid #11304e;border-radius:16px;box-shadow:0 20px 60px #0009}
  .modal .box header{padding:12px 16px;background:#102a43;border-bottom:1px solid #11304e;border-radius:16px 16px 0 0;display:flex;align-items:center;justify-content:space-between}
  .modal .box main{padding:14px 16px;line-height:1.55}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#111827;color:#e5e7eb;border:1px solid #374151;padding:2px 6px;border-radius:6px}

  /* MÃ©tricas finales */
  .end-screen{display:none;place-items:center;padding:24px}
  .end-screen.show{display:grid}
  .metrics{display:grid;gap:8px;background:#0b2239;border:1px solid #11304e;border-radius:16px;padding:16px;max-width:720px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .medals{display:flex;flex-wrap:wrap;gap:8px}
  .medal{background:#1f2937;border:1px solid #374151;padding:8px 10px;border-radius:999px}

  .tiny{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <header class="topbar" aria-label="Barra superior de estado">
    <div class="stats">
      <div class="pill" id="progress" aria-live="polite">Progreso: 0/10</div>
      <div class="pill hearts" id="hearts" aria-live="polite">â™¥â™¥â™¥</div>
      <div class="pill" id="streak" aria-live="polite">Racha: 0</div>
      <div class="pill" id="score" aria-live="polite">Puntaje: 0</div>
      <div class="pill" id="timer" aria-live="polite" title="Tiempo restante en Modo Avalancha">â±ï¸ 2:00</div>
    </div>
    <div class="menu">
      <label class="toggle" tabindex="0" id="voiceToggle" aria-label="Alternar voz de la Directora"><span>ğŸ”Š Voz</span><input type="checkbox" id="voiceChk" checked aria-label="Voz activada"></label>
      <label class="toggle" tabindex="0" id="rushToggle" aria-label="Alternar Modo Avalancha"><span>ğŸŒªï¸ Avalancha</span><input type="checkbox" id="rushChk" aria-label="Avalancha desactivado"></label>
      <button class="pill" id="helpBtn" aria-label="Ayuda y tutorial (H)">â“ Ayuda</button>
    </div>
  </header>

  <main class="container" id="game" aria-live="polite">
    <!-- Panel Izquierdo: Mensaje -->
    <section class="panel" aria-label="Panel del mensaje actual">
      <div class="head"><strong>ğŸ“¬ Mensaje en inspecciÃ³n</strong><span class="tiny" id="msgId"></span></div>
      <div class="body">
        <div class="card" id="messageCard" aria-describedby="toolsHelp">
          <div class="row"><div class="label">Remitente</div><div id="from"></div></div>
          <div class="row"><div class="label">Asunto</div><div id="subject"></div></div>
          <div class="row"><div class="label">Cuerpo</div><div id="bodyText" class="message-body"></div></div>
          <div class="row"><div class="label">Enlaces</div><div id="links" class="links"></div></div>
        </div>
        <div class="canvas-wrap" aria-hidden="true"><canvas id="fx"></canvas></div>
        <div class="actions" role="group" aria-label="Acciones de decisiÃ³n">
          <button id="approveBtn" class="btn btn-yes" aria-label="Aprobar mensaje (A)">ğŸ‘ APROBAR</button>
          <button id="rejectBtn" class="btn btn-no" aria-label="Rechazar mensaje (R)">ğŸ‘ RECHAZAR</button>
        </div>
      </div>
    </section>

    <!-- Panel Derecho: Herramientas -->
    <aside class="panel" aria-label="Panel de herramientas">
      <div class="head"><strong>ğŸ§° Herramientas de Inspector</strong></div>
      <div class="body tools" id="tools">
        <button class="tool-btn" id="toolSpell" aria-label="Lupa de OrtografÃ­a (1)" title="Lupa de OrtografÃ­a âœï¸ (1)"><span>âœï¸</span><div><div><strong>Lupa de OrtografÃ­a</strong></div><div class="tool-legend">Resalta faltas, marcas raras y nombres mal escritos.</div></div></button>
        <button class="tool-btn" id="toolUrgency" aria-label="Reloj de Urgencia (2)" title="Reloj de Urgencia â° (2)"><span>â°</span><div><div><strong>Reloj de Urgencia</strong></div><div class="tool-legend">Resalta frases de prisa o miedo.</div></div></button>
        <button class="tool-btn" id="toolLinks" aria-label="EscÃ¡ner de Enlaces (3)" title="EscÃ¡ner de Enlaces ğŸ”— (3)"><span>ğŸ”—</span><div><div><strong>EscÃ¡ner de Enlaces</strong></div><div class="tool-legend">Muestra URL real y marca dominios sospechosos.</div></div></button>
        <p id="toolsHelp" class="tiny">Atajos: <span class="kbd">1</span> Lupa, <span class="kbd">2</span> Reloj, <span class="kbd">3</span> EscÃ¡ner â€” <span class="kbd">A</span> Aprobar, <span class="kbd">R</span> Rechazar, <span class="kbd">N</span> Siguiente, <span class="kbd">H</span> Ayuda.</p>
      </div>
    </aside>
  </main>

  <!-- Barra inferior de feedback -->
  <footer class="bottombar" aria-label="Barra de feedback">
    <div class="inner">
      <div id="feedbackIcon">ğŸ•µï¸â€â™€ï¸</div>
      <div class="feedback" id="feedbackText">Bienvenido/a. Usa las herramientas para analizar el mensaje.</div>
      <button class="pill" id="nextBtn" aria-label="Siguiente mensaje (N)">â¡ï¸ Siguiente</button>
    </div>
  </footer>

  <!-- Pantalla final -->
  <section class="end-screen" id="endScreen" aria-label="Pantalla de mÃ©tricas finales">
    <div class="metrics">
      <h2>ğŸ“Š Resultados de la InspecciÃ³n</h2>
      <div id="summary"></div>
      <div class="grid2">
        <div>
          <h3>MÃ©tricas</h3>
          <ul id="metricList"></ul>
        </div>
        <div>
          <h3>Medallas</h3>
          <div class="medals" id="medals"></div>
        </div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-yes" id="retryBtn" aria-label="Reintentar">ğŸ” Reintentar</button>
        <button class="btn" style="background:#3b82f6;border:2px solid #1e3a8a" id="toggleModeBtn">ğŸŒªï¸ Alternar Avalancha</button>
      </div>
      <p class="tiny">Consejo: <em>â€œCon ojo de inspector, atento y sagaz, ningÃºn mensaje falso me engaÃ±arÃ¡ jamÃ¡s.â€</em></p>
    </div>
  </section>

  <!-- Modal Ayuda / Tutorial -->
  <div class="modal" id="helpModal" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
    <div class="box">
      <header>
        <h2 id="helpTitle">ğŸ“– Tutorial â€” La Central de Correo</h2>
        <button class="pill" id="closeHelp" aria-label="Cerrar ayuda">Cerrar</button>
      </header>
      <main>
        <p><strong>Objetivo:</strong> Identifica seÃ±ales comunes de mensajes engaÃ±osos y <u>rechaza</u> los peligrosos. Aprueba solo los seguros.</p>
        <ul>
          <li>SeÃ±al 1 â€” <strong>Errores OrtogrÃ¡ficos</strong> (ej. â€œNetflizâ€, â€œBanc0â€)</li>
          <li>SeÃ±al 2 â€” <strong>Urgencia Falsa</strong> (â€œÂ¡ActÃºa AHORA o perderÃ¡s tu cuenta!â€)</li>
          <li>SeÃ±al 3 â€” <strong>Enlaces Raros</strong> (texto no coincide, TLD extraÃ±o, <span class="kbd">.exe</span>)</li>
        </ul>
        <p><strong>Herramientas:</strong> âœï¸ Lupa (1), â° Reloj (2), ğŸ”— EscÃ¡ner (3). Ãšsalas para ganar puntos extra.</p>
        <p><strong>Atajos:</strong> <span class="kbd">A</span> Aprobar, <span class="kbd">R</span> Rechazar, <span class="kbd">N</span> Siguiente, <span class="kbd">H</span> Ayuda.</p>
        <p><strong>Consejo:</strong> Nunca compartas contraseÃ±as. Si dudas, Â¡pide ayuda!</p>
      </main>
    </div>
  </div>

<script>
/* =====================================================
   La Central de Correo: Inspector Anti-Phishing
   Juego educativo offline en un solo archivo.
   PÃºblico: 3Â° Primaria | Tema: CiudadanÃ­a Digital
   ===================================================== */
;
(function(){
  'use strict'

  /* ==========================
     Datos de los 10 mensajes
     ========================== */
  const MESSAGES_BASE = [
    {
      id:'BANC0', remitente:'Banc0 Nacionnal', asunto:'Alerta de seguriddad URGENTE',
      cuerpo:'Has clik aquÃ­ para verificar tu kuenta AHORA MISMO.',
      links:['http://verifica-banco-securo.biz/login'],
      banderas:{ortografia:true, urgencia:true, enlaceRaro:true, pideContrasena:false, adjuntoEjecutable:false},
      esSeguro:false,
      pistas:['Banc\u0030 Nacionnal','clik/kuenta','AHORA MISMO','dominio .biz']
    },
    {
      id:'GAMEP', remitente:'GamePlanet', asunto:'Tu recibo de compra',
      cuerpo:'Hola, [Tu Nombre]. Gracias por tu compra. AquÃ­ estÃ¡ tu recibo.',
      links:['https://www.gameplanet.com/orden/123'],
      banderas:{}, esSeguro:true, pistas:[]
    },
    {
      id:'AVATAR', remitente:'Mundo Avatar Sorteos', asunto:'Â¡Â¡FELICIDADES!! 5,000 gemas te esperan',
      cuerpo:'Inicia sesiÃ³n con tu usuario y contraseÃ±a para reclamar.',
      links:['https://mundoavatar.premios.net/login'],
      banderas:{enlaceRaro:true, pideContrasena:true}, esSeguro:false,
      pistas:['pide contraseÃ±a','subdominio premios.net']
    },
    {
      id:'PAQ', remitente:'Servicio Postal Veloz', asunto:'Entrega pendiente',
      cuerpo:'Haz clic para reprogramar tu envÃ­o.',
      links:['http://seguimiento-paquetes.xyz/track.html'],
      banderas:{enlaceRaro:true}, esSeguro:false, pistas:['dominio genÃ©rico .xyz']
    },
    {
      id:'LEO', remitente:'Tu amigo Leo', asunto:'Video de gatitos ğŸ˜‚',
      cuerpo:'Mira este video, es increÃ­ble jajaja.',
      links:['http://videosdivertidos.co/gatito.exe'],
      banderas:{adjuntoEjecutable:true}, esSeguro:false, pistas:['.exe marcado en rojo']
    },
    {
      id:'SCHOOL', remitente:'CoordinaciÃ³n Escolar', asunto:'ReuniÃ³n de padres â€” recordatorio',
      cuerpo:'La reuniÃ³n serÃ¡ el martes a las 17:00 en la sala A.',
      links:['https://portal.colegio.edu/eventos/reunion'],
      banderas:{}, esSeguro:true, pistas:[]
    },
    {
      id:'NFLIX', remitente:'Netfliz Soporte', asunto:'Problema con tu pago',
      cuerpo:'Actualiza tu pago en los prÃ³ximos 10 minutos o cancelaremos tu cuenta.',
      links:['http://netfliz-update-pay.com'],
      banderas:{ortografia:true, urgencia:true, enlaceRaro:true}, esSeguro:false,
      pistas:['Netfliz','10 minutos','dominio sospechoso']
    },
    {
      id:'BIB', remitente:'Biblioteca Municipal', asunto:'DevoluciÃ³n de libros',
      cuerpo:'Tu prÃ©stamo vence el viernes. Gracias por tu visita.',
      links:['https://biblioteca.ciudad.mx/usuario'],
      banderas:{}, esSeguro:true, pistas:[]
    },
    {
      id:'TOYS', remitente:'SuperToys', asunto:'Â¡Ganaste un auto de juguete gigante!',
      cuerpo:'Solo ingresa tu correo y contraseÃ±a para reclamar tu premio.',
      links:['https://supertys-promos.win/claim'],
      banderas:{pideContrasena:true, enlaceRaro:true}, esSeguro:false,
      pistas:['pide contraseÃ±a','TLD .win']
    },
    {
      id:'LAPIZ', remitente:'PapelerÃ­a El LÃ¡piz', asunto:'10% en cuadernos',
      cuerpo:'Oferta de la semana. No necesitas iniciar sesiÃ³n.',
      links:['https://lapiz.tienda/ofertas'],
      banderas:{}, esSeguro:true, pistas:[]
    }
  ];

  /* =============================
     Listas de detecciÃ³n educativa
     ============================= */
  const MISSPELLINGS = [
    /netfliz/gi, /banc0/gi, /nacionnal/gi, /seguriddad/gi, /clik/gi, /kuenta/gi,
  ];
  const URGENCY = [
    /ahora mismo/gi, /ahora/gi, /Ãºltima oportunidad/gi, /10 minutos/gi, /cancelaremos tu cuenta/gi, /urgente/gi
  ];
  const SUSP_TLDS = ['.biz','.xyz','.win'];

  /* =====================
     MÃ³dulo Audio y Voz
     ===================== */
  const AudioVoice = (function(){
    let voiceOn = true;
    const ctx = new (window.AudioContext||window.webkitAudioContext)();

    function beep(freq=440, dur=0.12){
      try{
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type='square';
        o.frequency.value=freq; o.connect(g); g.connect(ctx.destination);
        g.gain.value=0.02; o.start(); setTimeout(()=>{o.stop();}, dur*1000);
      }catch{}
    }
    function chimeOK(){ beep(660,.08); setTimeout(()=>beep(880,.09),100); }
    function siren(){ beep(180,.25); setTimeout(()=>beep(120,.25),260); }

    function speak(text){
      if(!voiceOn) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'es-MX'; u.rate=1; u.pitch=1; u.volume=1;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }
    function toggle(on){ voiceOn = on; if(!on) window.speechSynthesis.cancel(); }

    return {chimeOK,siren,speak,toggle}
  })();

  /* =====================
     Estado del Juego
     ===================== */
  const GameState = (function(){
    const state = {
      deck:[], index:0, lives:3, score:0, streak:0, maxStreak:0,
      usedSpell:false, usedUrg:false, usedLink:false,
      toolBonus:false, /* bandera temporal para +50 */
      spellFinds:0, urgencyFinds:0, linkFinds:0,
      corrections:0, /* veces que se permitiÃ³ corregir */
      avalanche:false, timeLeft:120, timerId:null,
      phishingDetected:0, safeApproved:0, errors:0,
      medals:{minucioso:false,ceroFN:false,vistaAguila:false}
    };

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
      return a;
    }
    function start(aval=false){
      Object.assign(state, {deck:shuffle(MESSAGES_BASE), index:0, lives:3, score:0, streak:0, maxStreak:0,
        usedSpell:false, usedUrg:false, usedLink:false, toolBonus:false, spellFinds:0, urgencyFinds:0, linkFinds:0,
        corrections:0, avalanche:aval, timeLeft:aval?120:0, phishingDetected:0, safeApproved:0, errors:0,
        medals:{minucioso:false,ceroFN:true,vistaAguila:false}
      });
      if(state.avalanche) startTimer(); else stopTimer();
    }
    function current(){ return state.deck[state.index]; }
    function next(){ state.index++; state.usedSpell=state.usedUrg=state.usedLink=false; state.toolBonus=false; }
    function alive(){ return state.lives>0; }
    function finished(){ return !state.avalanche && state.index>=10; }

    function startTimer(){ stopTimer(); state.timeLeft=120; state.timerId = setInterval(()=>{
      state.timeLeft--; UI.renderTimer(); if(state.timeLeft<=0){ stopTimer(); UI.endGame(); }
    },1000); }
    function stopTimer(){ if(state.timerId){ clearInterval(state.timerId); state.timerId=null; } }

    return {state,start,current,next,alive,finished,startTimer,stopTimer}
  })();

  /* =====================
     Motor de Mensajes
     ===================== */
  const MessageEngine = (function(){
    function renderMessage(msg){
      UI.set('#msgId', `ID: ${msg.id}`);
      UI.set('#from', escapeHTML(msg.remitente));
      UI.set('#subject', escapeHTML(msg.asunto));
      UI.set('#bodyText', escapeHTML(msg.cuerpo));
      const links = msg.links||[];
      const container = document.querySelector('#links');
      container.innerHTML = '';
      links.forEach(url=>{
        const a = document.createElement('a');
        a.href = '#'; a.textContent = url; a.setAttribute('data-real-url', url);
        a.setAttribute('role','link'); a.setAttribute('tabindex','0');
        a.addEventListener('mouseenter', showURLBubble);
        a.addEventListener('mouseleave', hideURLBubble);
        a.addEventListener('focus', showURLBubble);
        a.addEventListener('blur', hideURLBubble);
        container.appendChild(a);
        const span = document.createElement('span'); span.className='tag';
        span.textContent = parseDomain(url);
        container.appendChild(span);
      });
      UI.clearHighlights();
      UI.drawCanvasNeutral();
      UI.feedback('ğŸ•µï¸â€â™€ï¸', 'Analiza el mensaje. Usa las herramientas.');
      updateHeader();
    }

    function updateHeader(){
      const s = GameState.state;
      UI.set('#progress', `Progreso: ${Math.min(s.index+1,10)}/10`);
      UI.set('#hearts', 'â™¥'.repeat(s.lives));
      UI.set('#streak', `Racha: ${s.streak}`);
      UI.set('#score', `Puntaje: ${s.score}`);
    }

    function parseDomain(url){
      try{ const u=new URL(url); return u.hostname; }catch{ return '(URL invÃ¡lida)'; }
    }

    function showURLBubble(e){
      const url = e.currentTarget.getAttribute('data-real-url');
      const bubble = document.createElement('div'); bubble.className='url-bubble'; bubble.textContent = `ğŸ” ${url}`;
      document.body.appendChild(bubble);
      const r = e.currentTarget.getBoundingClientRect();
      bubble.style.left = (r.left + r.width/2) + 'px';
      bubble.style.top = (r.top) + 'px';
    }
    function hideURLBubble(){
      document.querySelectorAll('.url-bubble').forEach(b=>b.remove());
    }

    return {renderMessage,updateHeader,parseDomain}
  })();

  /* ===============
     Herramientas
     =============== */
  const Tools = (function(){
    function useSpell(){
      const body = document.querySelector('#bodyText');
      const fields = [document.querySelector('#from'), document.querySelector('#subject'), body];
      let found=0;
      fields.forEach(el=>{
        MISSPELLINGS.forEach(rx=>{ found += UI.wrapMatches(el, rx, 'highlight-red'); });
      });
      if(found>0){
        GameState.state.spellFinds+=found; GameState.state.usedSpell=true; GameState.state.toolBonus=true;
        UI.feedback('âœï¸','SeÃ±ales ortogrÃ¡ficas detectadas: '+found);
        AudioVoice.chimeOK();
      }else{
        UI.feedback('âœï¸','No se encontraron faltas evidentes.');
      }
      UI.bumpTool('#toolSpell');
    }

    function useUrgency(){
      const body = document.querySelector('#bodyText');
      let found=0; URGENCY.forEach(rx=>{ found += UI.wrapMatches(body, rx, 'highlight-yellow'); });
      if(found>0){
        GameState.state.urgencyFinds+=found; GameState.state.usedUrg=true; GameState.state.toolBonus=true;
        UI.feedback('â°','Frases de urgencia resaltadas: '+found);
        AudioVoice.chimeOK();
      }else{ UI.feedback('â°','No hay seÃ±ales de urgencia destacadas.'); }
      UI.bumpTool('#toolUrgency');
    }

    function useLinks(){
      const links = Array.from(document.querySelectorAll('#links a'));
      let suspicious=0;
      links.forEach(a=>{
        const url=a.getAttribute('data-real-url');
        const host = MessageEngine.parseDomain(url);
        const tld = SUSP_TLDS.find(t=>host.endsWith(t));
        if(tld){ suspicious++; a.classList.add('highlight-red'); }
        if(/\.exe(\b|$)/i.test(url)){ suspicious++; a.classList.add('highlight-red'); }
      });
      if(suspicious>0){
        GameState.state.linkFinds+=suspicious; GameState.state.usedLink=true; GameState.state.toolBonus=true;
        if(GameState.state.linkFinds>=3) GameState.state.medals.vistaAguila=true;
        UI.feedback('ğŸ”—',`Enlaces sospechosos: ${suspicious}. Verifica dominios/TLD y adjuntos .exe.`);
        AudioVoice.chimeOK();
      }else{ UI.feedback('ğŸ”—','Enlaces sin seÃ±ales evidentes.'); }
      UI.bumpTool('#toolLinks');
    }

    return {useSpell,useUrgency,useLinks}
  })();

  /* ==========
     UI & FX
     ========== */
  const UI = (function(){
    const $ = (sel)=>document.querySelector(sel);
    function set(sel, html){ $(sel).innerHTML = html; }
    function feedback(icon, text){ $('#feedbackIcon').textContent=icon; $('#feedbackText').textContent=text; if($('#voiceChk').checked) AudioVoice.speak(text); }
    function clearHighlights(){ ['#from','#subject','#bodyText','#links'].forEach(s=>$(s).innerHTML = $(s).innerHTML); }

    function wrapMatches(container, regex, cls){
      const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null);
      const toWrap=[];
      while(walker.nextNode()){
        const node = walker.currentNode;
        if(regex.test(node.textContent)){
          toWrap.push({node:node, text:node.textContent});
          regex.lastIndex=0;
        }
      }
      let count=0;
      toWrap.forEach(({node,text})=>{
        const html = text.replace(regex, m=>{ count++; return `<span class="${cls}">${m}</span>`; });
        const span = document.createElement('span'); span.innerHTML = html; node.replaceWith(span);
      });
      return count;
    }

    function bumpTool(sel){ const el=$(sel); el.style.transform='scale(1.02)'; setTimeout(()=>el.style.transform='',150); }

    // Canvas simples para efectos â€œtuboâ€ y â€œincineradorâ€
    const cvs = document.getElementById('fx');
    const ctx = cvs.getContext('2d');
    function resize(){ const r=cvs.getBoundingClientRect(); cvs.width=r.width*2; cvs.height=r.height*2; }
    window.addEventListener('resize', resize); resize();

    function drawCanvasNeutral(){ resize(); ctx.clearRect(0,0,cvs.width,cvs.height); ctx.fillStyle='#0a1f2f'; ctx.fillRect(0,0,cvs.width,cvs.height); drawConveyor(); }
    function drawConveyor(){ ctx.strokeStyle='#274'; ctx.lineWidth=6; ctx.setLineDash([20,14]); ctx.beginPath(); ctx.moveTo(20, cvs.height-40); ctx.lineTo(cvs.width-20, cvs.height-40); ctx.stroke(); ctx.setLineDash([]); }

    function animateTube(ok=true){ drawCanvasNeutral(); const color= ok? '#31c48d' : '#ef4444'; let x=20; const y=60; const w=80; const h=40; const id=setInterval(()=>{
      ctx.fillStyle=color; ctx.fillRect(x,y,w,h); ctx.fillStyle='rgba(255,255,255,.2)'; ctx.fillRect(x+10,y+8,20,8); x+=24; if(x>cvs.width-100){ clearInterval(id); }
    },40); }

    function animateIncinerate(){ drawCanvasNeutral(); let r=10; const cx=cvs.width-80, cy=cvs.height-80; const id=setInterval(()=>{
      ctx.fillStyle='rgba(239,68,68,.25)'; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill(); r+=14; if(r>160){ clearInterval(id);} },30);
    }

    function renderTimer(){ const s = GameState.state; const m=Math.floor(s.timeLeft/60); const sec=String(s.timeLeft%60).padStart(2,'0'); set('#timer',`â±ï¸ ${m}:${sec}`); }

    return {set,feedback,wrapMatches,bumpTool,clearHighlights,drawCanvasNeutral,animateTube,animateIncinerate,renderTimer}
  })();

  /* ===============
     MÃ©tricas
     =============== */
  const Metrics = (function(){
    function endSummary(){
      const s = GameState.state;
      const analyzed = Math.min(10, s.index);
      const txt = `Â¡InspecciÃ³n ${s.errors===0?'impecable':'completada'}! Analizaste ${analyzed} mensajes, detectaste ${s.phishingDetected} intentos de phishing y protegiste la ciudad. Identificaste ${s.spellFinds} errores ortogrÃ¡ficos y ${s.linkFinds} enlaces peligrosos. Â¡Eres ${s.errors<=1?'un Inspector de Ã©lite':'un gran Inspector'}!`;
      return txt;
    }
    return {endSummary}
  })();

  /* =============================
     LÃ³gica principal del juego
     ============================= */
  function startGame(aval=false){
    GameState.start(aval);
    document.getElementById('endScreen').classList.remove('show');
    document.getElementById('game').style.display='grid';
    loadCurrent();
  }

  function loadCurrent(){
    const msg = GameState.current();
    MessageEngine.renderMessage(msg);
    if(GameState.state.index===0){ introBriefing(); }
  }

  function introBriefing(){
    const line = 'Â¡AtenciÃ³n, Inspector! Protege a la ciudad de las Cartas-Trampa. Busca faltas, urgencia y enlaces raros.';
    UI.feedback('ğŸ¬', line);
    if(document.getElementById('voiceChk').checked) AudioVoice.speak(line);
  }

  function judge(decision){
    const s = GameState.state; const msg = GameState.current();
    const correct = (decision==='approve') ? msg.esSeguro : !msg.esSeguro;

    let scoreDelta=0; let lifeDelta=0; let text=''; let icon='';
    if(correct){
      // Puntos base
      scoreDelta += 100;
      // Bonus por herramienta utilizada antes de decidir
      if(s.toolBonus){ scoreDelta += 50; }
      // Bonus por racha
      s.streak++; s.maxStreak = Math.max(s.maxStreak, s.streak); scoreDelta += Math.max(0,(s.streak-1))*20;
      if(msg.esSeguro){ s.safeApproved++; UI.animateTube(true); text='Â¡Mensaje seguro! Â¡Luz verde para la entrega!'; icon='ğŸŸ¢'; }
      else{ s.phishingDetected++; UI.animateIncinerate(); text='Â¡Phishing detectado y neutralizado! Â¡Gran trabajo de inspecciÃ³n!'; icon='ğŸ”¥'; }
      AudioVoice.chimeOK();
      UI.feedback(icon, text);

      // Medalla Inspector Minucioso si usÃ³ las 3 herramientas alguna vez
      if(s.usedSpell && s.usedUrg && s.usedLink) s.medals.minucioso = true;

      s.score += scoreDelta;
      proceedNext();
    } else {
      // Error
      s.errors++; s.streak=0; scoreDelta -= 100; lifeDelta = -1; s.lives += lifeDelta; UI.feedback('ğŸš¨','Â¡Alerta, Inspector! Ese mensaje era una trampa. Revisa las pistas y corrige.'); AudioVoice.siren();
      // Permitir una correcciÃ³n: no avanzamos de mensaje, pero solo una vez por carta
      s.corrections++;
      if(s.lives<=0){ endGame(); return; }
      // mantener el mensaje y permitir otra decisiÃ³n (sin mÃ¡s penalizaciÃ³n si ahora acierta)
    }
    MessageEngine.updateHeader();
  }

  function proceedNext(){
    const s = GameState.state;
    if(!s.avalanche && s.index>=9){ endGame(); return; }
    s.index++;
    if(s.avalanche){ // en avalancha, rotamos del pool infinito
      if(s.index>=MESSAGES_BASE.length) s.index=0;
    }
    s.usedSpell=s.usedUrg=s.usedLink=false; s.toolBonus=false; loadCurrent();
  }

  function endGame(){
    GameState.stopTimer();
    document.getElementById('game').style.display='none';
    const s = GameState.state;
    const sum = Metrics.endSummary();
    document.getElementById('summary').textContent = sum;

    const list = document.getElementById('metricList'); list.innerHTML='';
    const add=(k,v)=>{ const li=document.createElement('li'); li.textContent=`${k}: ${v}`; list.appendChild(li); };
    add('Mensajes analizados', Math.min(10, s.index));
    add('Phishing detectados', s.phishingDetected);
    add('Seguros aprobados', s.safeApproved);
    add('Errores cometidos', s.errors);
    add('Racha mÃ¡xima', s.maxStreak);
    add('Faltas detectadas', s.spellFinds);
    add('Urgencias detectadas', s.urgencyFinds);
    add('Enlaces peligrosos', s.linkFinds);
    add('Puntaje final', s.score);

    const medals = document.getElementById('medals'); medals.innerHTML='';
    if(s.medals.minucioso){ medals.appendChild(medal('Inspector Minucioso')); }
    if(s.medals.ceroFN && s.phishingDetected>=4 && s.errors===0){ medals.appendChild(medal('Cero Falsos Negativos')); }
    if(s.medals.vistaAguila){ medals.appendChild(medal('Vista de Ãguila')); }

    document.getElementById('endScreen').classList.add('show');
  }

  function medal(text){ const div=document.createElement('div'); div.className='medal'; div.textContent='ğŸ… '+text; return div; }

  /* ===================
     Utilidades varias
     =================== */
  function escapeHTML(s){ return String(s).replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }

  /* ===================
     Controles & eventos
     =================== */
  function bind(){
    // Tools
    document.getElementById('toolSpell').addEventListener('click', Tools.useSpell);
    document.getElementById('toolUrgency').addEventListener('click', Tools.useUrgency);
    document.getElementById('toolLinks').addEventListener('click', Tools.useLinks);

    // Actions
    document.getElementById('approveBtn').addEventListener('click', ()=>judge('approve'));
    document.getElementById('rejectBtn').addEventListener('click', ()=>judge('reject'));
    document.getElementById('nextBtn').addEventListener('click', proceedNext);

    // Help modal
    const modal = document.getElementById('helpModal');
    document.getElementById('helpBtn').addEventListener('click', ()=>{modal.classList.add('show')});
    document.getElementById('closeHelp').addEventListener('click', ()=>{modal.classList.remove('show')});
    modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.classList.remove('show'); });

    // Voice & Avalancha toggles
    document.getElementById('voiceChk').addEventListener('change', (e)=>AudioVoice.toggle(e.target.checked));
    document.getElementById('rushChk').addEventListener('change', (e)=>{
      if(e.target.checked){ GameState.state.avalanche=true; GameState.startTimer(); }
      else{ GameState.state.avalanche=false; GameState.stopTimer(); UI.set('#timer','â±ï¸ 2:00'); }
    });

    // Retry & toggle mode (en pantalla final)
    document.getElementById('retryBtn').addEventListener('click', ()=>startGame(GameState.state.avalanche));
    document.getElementById('toggleModeBtn').addEventListener('click', ()=>startGame(!GameState.state.avalanche));

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if(e.key==='1'){ e.preventDefault(); Tools.useSpell(); }
      else if(e.key==='2'){ e.preventDefault(); Tools.useUrgency(); }
      else if(e.key==='3'){ e.preventDefault(); Tools.useLinks(); }
      else if(e.key.toLowerCase()==='a'){ e.preventDefault(); document.getElementById('approveBtn').click(); }
      else if(e.key.toLowerCase()==='r'){ e.preventDefault(); document.getElementById('rejectBtn').click(); }
      else if(e.key.toLowerCase()==='n'){ e.preventDefault(); proceedNext(); }
      else if(e.key.toLowerCase()==='h'){ e.preventDefault(); document.getElementById('helpBtn').click(); }
    });
  }

  // Inicio
  bind();
  // Saludo de la Directora
  setTimeout(()=>{
    if(document.getElementById('voiceChk').checked){
      AudioVoice.speak('Â¡AtenciÃ³n, Inspector! Protege a la ciudad de las Cartas-Trampa. Busca faltas, urgencia y enlaces raros.');
    }
  }, 400);
  startGame(false);
})();
</script>
</body>
</html>
